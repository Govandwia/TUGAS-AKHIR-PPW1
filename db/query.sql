-- Creating the laptop_store database
CREATE TABLESPACE laptop_store_data;

-- Switching to the laptop_store database
ALTER SESSION SET CURRENT_SCHEMA = laptop_store;

-- Creating the users table
CREATE TABLE users (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    username VARCHAR2(50) NOT NULL,
    password VARCHAR2(255) NOT NULL,
    email VARCHAR2(100) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Creating the products table
CREATE TABLE products (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR2(100) NOT NULL,
    description CLOB,
    price NUMBER(10, 2) NOT NULL,
    stock NUMBER NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    image_url VARCHAR2(255) NOT NULL
);

-- Creating the orders table
CREATE TABLE orders (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id NUMBER,
    total NUMBER(10, 2) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- Creating the order_items table
CREATE TABLE order_items (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    order_id NUMBER,
    product_id NUMBER,
    quantity NUMBER NOT NULL,
    price NUMBER(10, 2) NOT NULL,
    FOREIGN KEY (order_id) REFERENCES orders(id),
    FOREIGN KEY (product_id) REFERENCES products(id)
);

-- Creating the reviews table
CREATE TABLE reviews (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    product_id NUMBER,
    user_id NUMBER,
    rating NUMBER CHECK (rating >= 1 AND rating <= 5),
    comment CLOB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (product_id) REFERENCES products(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
);


INSERT INTO products (name, description, price, stock, image_url)
VALUES ('Lenovo ThinkPad X1 Carbon', 'A lightweight and durable 14-inch laptop with a long battery life.', 1499.99, 10, 'https://www.lenovo.com/us/en/d/thinkpad-x1-carbon/');

INSERT INTO products (name, description, price, stock, image_url)
VALUES ('ASUS ZenBook 13 OLED', 'A sleek and stylish 13.3-inch laptop with a stunning OLED display.', 1199.99, 15, 'https://www.asus.com/laptops/for-home/zenbook/zenbook-13-oled-ux325-11th-gen-intel/');

INSERT INTO products (name, description, price, stock, image_url)
VALUES ('Apple MacBook Air M1', 'A powerful and portable 13.3-inch laptop with Apple''s M1 chip.', 999.99, 8, 'https://www.apple.com/am/macbook-air-m1/');

INSERT INTO products (name, description, price, stock, image_url)
VALUES ('Dell XPS 13', 'A premium 13.4-inch laptop with a beautiful InfinityEdge display.', 1299.99, 12, 'https://www.dell.com/en-us/shop/dell-laptops/xps-13-laptop/spd/xps-13-9315-laptop');

INSERT INTO products (name, description, price, stock, image_url)
VALUES ('HP Spectre x360', 'A versatile 13.5-inch convertible laptop that can be used as a laptop, tablet, or tent.', 1399.99, 7, 'https://www.hp.com/us-en/shop/pdp/hp-spectre-x360-2-in-1-laptop-14t-eu000-14-7k635av-1');

INSERT INTO products (name, description, price, stock, image_url)
VALUES ('Microsoft Surface Laptop Studio', 'A powerful and versatile 14.4-inch laptop with a detachable keyboard.', 1699.99, 5, 'https://www.microsoft.com/en-us/d/surface-laptop-studio-2/8rqr54krf1dz');

-- user
INSERT INTO users (id, username, password, email, created_at)
VALUES (1, 'john_doe', 'password123', 'john.doe@example.com', CURRENT_TIMESTAMP);

INSERT INTO users (id, username, password, email, created_at)
VALUES (2, 'jane_smith', 'qwerty', 'jane.smith@example.com', CURRENT_TIMESTAMP);

INSERT INTO users (id, username, password, email, created_at)
VALUES (3, 'mike_jackson', 'mike123', 'mike.jackson@example.com', CURRENT_TIMESTAMP);

-- products

INSERT INTO products (id, name, description, price, stock, created_at, image_url)
VALUES (1, 'Laptop X1', 'Powerful laptop with high performance.', 1299.99, 15, CURRENT_TIMESTAMP, 'laptop_x1.jpg');

INSERT INTO products (id, name, description, price, stock, created_at, image_url)
VALUES (2, 'Laptop Y2', 'Lightweight and portable laptop for everyday use.', 899.99, 20, CURRENT_TIMESTAMP, 'laptop_y2.jpg');

INSERT INTO products (id, name, description, price, stock, created_at, image_url)
VALUES (3, 'Laptop Z3', 'Gaming laptop with dedicated graphics card.', 1799.99, 10, CURRENT_TIMESTAMP, 'laptop_z3.jpg');

INSERT INTO products (id, name, description, price, stock, created_at, image_url)
VALUES (4, 'Laptop A4', 'Sleek design with ultra-fast performance.', 1499.99, 18, CURRENT_TIMESTAMP, 'laptop_a4.jpg');

INSERT INTO products (id, name, description, price, stock, created_at, image_url)
VALUES (5, 'Laptop B5', 'Convertible laptop with touchscreen display.', 1099.99, 25, CURRENT_TIMESTAMP, 'laptop_b5.jpg');

INSERT INTO products (id, name, description, price, stock, created_at, image_url)
VALUES (6, 'Laptop C6', 'Budget-friendly laptop for students.', 699.99, 30, CURRENT_TIMESTAMP, 'laptop_c6.jpg');

INSERT INTO products (id, name, description, price, stock, created_at, image_url)
VALUES (7, 'Laptop D7', 'Professional-grade laptop with long battery life.', 1999.99, 12, CURRENT_TIMESTAMP, 'laptop_d7.jpg');

-- orders
INSERT INTO orders (id, user_id, total, created_at)
VALUES (1, 1, 1299.99, CURRENT_TIMESTAMP);

INSERT INTO orders (id, user_id, total, created_at)
VALUES (2, 2, 1799.99, CURRENT_TIMESTAMP);

INSERT INTO orders (id, user_id, total, created_at)
VALUES (3, 3, 899.99, CURRENT_TIMESTAMP);

-- order_items
INSERT INTO order_items (id, order_id, product_id, quantity, price)
VALUES (1, 1, 1, 1, 1299.99);

INSERT INTO order_items (id, order_id, product_id, quantity, price)
VALUES (2, 2, 3, 1, 1799.99);

INSERT INTO order_items (id, order_id, product_id, quantity, price)
VALUES (3, 3, 2, 2, 1799.98);

INSERT INTO order_items (id, order_id, product_id, quantity, price)
VALUES (4, 3, 1, 1, 899.99);

-- reviews
INSERT INTO reviews (id, product_id, user_id, rating, comment, created_at)
VALUES (1, 1, 1, 5, 'Great laptop, exceeded my expectations.', CURRENT_TIMESTAMP);

INSERT INTO reviews (id, product_id, user_id, rating, comment, created_at)
VALUES (2, 3, 2, 4, 'Excellent gaming performance, but a bit heavy.', CURRENT_TIMESTAMP);

INSERT INTO reviews (id, product_id, user_id, rating, comment, created_at)
VALUES (3, 2, 3, 4, 'Perfect for everyday use, lightweight and fast.', CURRENT_TIMESTAMP);



-- 1.
SELECT p.id AS product_id, p.name AS product_name, p.description AS product_description, p.price AS product_price, p.stock AS product_stock,
       r.rating AS review_rating, r.comment AS review_comment, r.created_at AS review_created_at
FROM products p
LEFT JOIN reviews r ON p.id = r.product_id;

-- 2.
SELECT o.id AS order_id, u.username AS user_username, p.name AS product_name, oi.quantity AS quantity_ordered, oi.price AS item_price
FROM orders o
JOIN users u ON o.user_id = u.id
JOIN order_items oi ON o.id = oi.order_id
JOIN products p ON oi.product_id = p.id;

-- 3.
SELECT p.id AS product_id, p.name AS product_name, AVG(r.rating) AS avg_rating
FROM products p
LEFT JOIN reviews r ON p.id = r.product_id
GROUP BY p.id, p.name;

-- 4.
CREATE VIEW available_products AS
SELECT id, name, description, price, stock
FROM products
WHERE stock > 0;

-- 5.
CREATE VIEW order_details AS
SELECT o.id AS order_id, u.username AS user_username, o.total, o.created_at
FROM orders o
JOIN users u ON o.user_id = u.id;

-- 6.
CREATE OR REPLACE FUNCTION calculate_order_total(order_id IN NUMBER) RETURN NUMBER IS
    total_amount NUMBER;
BEGIN
    SELECT SUM(quantity * price) INTO total_amount
    FROM order_items
    WHERE order_id = order_id;

    RETURN total_amount;
END;

-- 7.
CREATE OR REPLACE PROCEDURE update_product_stock(order_id IN NUMBER) IS
BEGIN
    UPDATE products p
    SET p.stock = p.stock - (SELECT quantity FROM order_items WHERE order_id = order_id)
    WHERE p.id IN (SELECT product_id FROM order_items WHERE order_id = order_id);
END;

-- 8.
CREATE OR REPLACE TRIGGER update_order_total
AFTER INSERT OR DELETE ON order_items
FOR EACH ROW
BEGIN
    UPDATE orders o
    SET o.total = (SELECT SUM(quantity * price) FROM order_items WHERE order_id = :new.order_id)
    WHERE o.id = :new.order_id;
END;

-- 9.
CREATE OR REPLACE TRIGGER send_review_notification
AFTER INSERT ON reviews
FOR EACH ROW
DECLARE
    reviewer_email VARCHAR2(100);
    product_name VARCHAR2(100);
    email_subject VARCHAR2(100);
    email_body VARCHAR2(4000);
BEGIN
    -- Mendapatkan email pengguna yang memberikan ulasan
    SELECT email INTO reviewer_email
    FROM users
    WHERE id = :new.user_id;

    -- Mendapatkan nama produk yang diulas
    SELECT name INTO product_name
    FROM products
    WHERE id = :new.product_id;

    -- Menyiapkan subjek dan isi email
    email_subject := 'Konfirmasi Ulasan Baru untuk Produk ' || product_name;
    email_body := 'Terima kasih atas ulasan Anda untuk produk ' || product_name || '. Ulasan Anda telah diterima dan akan ditampilkan di halaman produk.';

    -- Mengirim email
    UTL_MAIL.send(sender => 'admin@toko-laptop.com',
                  recipients => reviewer_email,
                  subject => email_subject,
                  message => email_body);
EXCEPTION
    WHEN OTHERS THEN
        -- Tangani kesalahan jika pengiriman email gagal
        DBMS_OUTPUT.put_line('Gagal mengirim email konfirmasi: ' || SQLERRM);
END;
/
